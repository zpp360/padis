<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ApplyMapper">
    <select id="listPage" parameterType="pd" resultType="pd">
        select
          *
        from m_apply t
        where t.del_flag = '0'
        <if test='user_role == "2"'>
            and t.apply_status in ('1','2')
        </if>
        <if test="insert_user != null and insert_user != ''">
            and t.insert_user = #{insert_user}
        </if>
        order by t.apply_status asc,t.update_time desc
        limit ${start},${page_size}
    </select>

    <select id="countListPage" parameterType="pd" resultType="java.lang.Long">
        select
          count(1)
        from m_apply t
        where t.del_flag = '0'
        <if test="insert_user != null and insert_user != ''">
            and t.insert_user = #{insert_user}
        </if>
    </select>

    <insert id="saveApply" parameterType="pd">
        insert into m_apply(
          apply_id,
          apply_name,
          apply_user,
          user_number,
          apply_number,
          certify_file_name,
          certify_file_path,
          apply_desc,
          apply_file_name,
          apply_file_path,
          apply_status,
          del_flag,
          insert_user,
          insert_time,
          update_user,
          update_time
        )values(
          #{apply_id},
          #{apply_name},
          #{apply_user},
          #{user_number},
          #{apply_number},
          #{certify_file_name},
          #{certify_file_path},
          #{apply_desc},
          #{apply_file_name},
          #{apply_file_path},
          #{apply_status},
          '0',
          #{insert_user},
          now(),
          #{update_user},
          now()
        )
    </insert>

    <update id="dealApply" parameterType="pd">
        update m_apply set
          apply_deal_file_name = #{apply_deal_file_name},
          apply_deal_file_path = #{apply_deal_file_path},
          apply_status = '2'
        where apply_id = #{apply_id}

    </update>

    <update id="delApply" parameterType="pd">
        update m_apply set
          del_flag = '1',
          update_user = #{update_user},
          update_time = now()
        where apply_id = #{apply_id}
    </update>

    <select id="findById" parameterType="java.lang.String" resultType="pd">
        select
          t.*,
          u.user_unit
        from m_apply t
        left join sys_user u
        on t.insert_user = u.user_id
        where t.del_flag = '0'
        and t.apply_id = #{applyId}
    </select>

    <update id="updateApply" parameterType="pd">
        update m_apply set
          apply_name  = #{apply_name},
          apply_user =#{apply_user},
          user_number=#{user_number},
          apply_number=#{apply_number},
          certify_file_name=#{certify_file_name},
          certify_file_path=#{certify_file_path},
          apply_desc=#{apply_desc},
          apply_file_name=#{apply_file_name},
          apply_file_path=#{apply_file_path},
          apply_status=#{apply_status},
          update_user=#{update_user},
          update_time = now()
        where apply_id = #{apply_id}

    </update>
</mapper>